name: Merge to Main - Documentation & Release

on:
  pull_request:
    types: [closed]
    branches:
      - Main

jobs:
  process-merge:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Dependencies
        run: |
          npm install -g semantic-release @semantic-release/changelog @semantic-release/git conventional-changelog-conventionalcommits

      - name: Analyze Changes
        id: analyze
        run: |
          # Obtener commits del PR
          COMMITS=$(git log --pretty=format:"%s" ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }})
          
          # Detectar tipos de cambios
          HAS_FEAT=$(echo "$COMMITS" | grep -c "^feat" || echo "0")
          HAS_FIX=$(echo "$COMMITS" | grep -c "^fix" || echo "0")
          HAS_BREAKING=$(echo "$COMMITS" | grep -c "BREAKING CHANGE" || echo "0")
          HAS_PERF=$(echo "$COMMITS" | grep -c "^perf" || echo "0")
          
          # Determinar tipo de release
          if [ "$HAS_BREAKING" -gt 0 ]; then
            RELEASE_TYPE="major"
            IS_NEW_VERSION="true"
          elif [ "$HAS_FEAT" -gt 0 ]; then
            RELEASE_TYPE="minor"
            IS_NEW_VERSION="true"
          elif [ "$HAS_FIX" -gt 0 ] || [ "$HAS_PERF" -gt 0 ]; then
            RELEASE_TYPE="patch"
            IS_NEW_VERSION="false"
          else
            RELEASE_TYPE="none"
            IS_NEW_VERSION="false"
          fi
          
          echo "release_type=$RELEASE_TYPE" >> $GITHUB_OUTPUT
          echo "is_new_version=$IS_NEW_VERSION" >> $GITHUB_OUTPUT
          echo "has_feat=$HAS_FEAT" >> $GITHUB_OUTPUT
          echo "has_fix=$HAS_FIX" >> $GITHUB_OUTPUT
          echo "has_breaking=$HAS_BREAKING" >> $GITHUB_OUTPUT

      - name: Run Semantic Release
        if: steps.analyze.outputs.release_type != 'none'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cat > .releaserc.json << 'EOF'
          {
            "branches": ["main"],
            "plugins": [
              ["@semantic-release/commit-analyzer", {
                "preset": "conventionalcommits",
                "releaseRules": [
                  {"type": "feat", "release": "minor"},
                  {"type": "fix", "release": "patch"},
                  {"type": "perf", "release": "patch"},
                  {"breaking": true, "release": "major"}
                ]
              }],
              ["@semantic-release/release-notes-generator", {
                "preset": "conventionalcommits"
              }],
              ["@semantic-release/changelog", {
                "changelogFile": "CHANGELOG.md"
              }],
              ["@semantic-release/git", {
                "assets": ["CHANGELOG.md", "documentos/**/*.md"],
                "message": "chore(release): ${nextRelease.version} [skip ci]\n\n${nextRelease.notes}"
              }],
              "@semantic-release/github"
            ]
          }
          EOF
          npx semantic-release

      - name: Get Version Info
        id: version
        run: |
          VERSION=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.1.0")
          PREV_VERSION=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "v0.0.0")
          echo "current=$VERSION" >> $GITHUB_OUTPUT
          echo "previous=$PREV_VERSION" >> $GITHUB_OUTPUT

      - name: Generate Feature Documentation
        if: steps.analyze.outputs.has_feat > 0
        run: |
          VERSION="${{ steps.version.outputs.current }}"
          DATE=$(date +%Y-%m-%d)
          PR_NUMBER=${{ github.event.pull_request.number }}
          
          mkdir -p documentos/funcionalidades
          
          # Extraer features del PR
          git log --pretty=format:"%s|||%b" ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }} | grep "^feat" | while IFS='|||' read -r subject body; do
            # Extraer mÃ³dulo y descripciÃ³n
            MODULE=$(echo "$subject" | sed -n 's/^feat(\([^)]*\)).*/\1/p')
            DESC=$(echo "$subject" | sed 's/^feat[^:]*: //')
            SLUG=$(echo "$DESC" | tr '[:upper:]' '[:lower:]' | tr ' ' '-' | tr -cd '[:alnum:]-')
            
            cat > "documentos/funcionalidades/${SLUG}.md" << EOF
          # ${DESC}
          
          ## InformaciÃ³n General
          - **MÃ³dulo**: ${MODULE}
          - **VersiÃ³n**: ${VERSION}
          - **Fecha**: ${DATE}
          - **PR**: #${PR_NUMBER}
          
          ## DescripciÃ³n Funcional
          ${body}
          
          ## DescripciÃ³n TÃ©cnica
          ImplementaciÃ³n de nueva funcionalidad en el mÃ³dulo ${MODULE}.
          
          ## Impacto
          - [ ] Modifica flujos existentes
          - [x] Agrega nueva funcionalidad
          - [ ] Requiere migraciÃ³n de datos
          
          ## Referencias
          - Pull Request: #${PR_NUMBER}
          - VersiÃ³n: ${VERSION}
          
          ---
          *Generado automÃ¡ticamente el ${DATE}*
          EOF
          done

      - name: Generate Version Documentation
        run: |
          VERSION="${{ steps.version.outputs.current }}"
          PREV_VERSION="${{ steps.version.outputs.previous }}"
          DATE=$(date +%Y-%m-%d)
          IS_NEW_VERSION="${{ steps.analyze.outputs.is_new_version }}"
          
          mkdir -p "documentos/versiones/${VERSION}"
          
          if [ "$IS_NEW_VERSION" = "true" ]; then
            # Nueva versiÃ³n
            cat > "documentos/versiones/${VERSION}/index.md" << EOF
          # VersiÃ³n ${VERSION}
          
          **Fecha de liberaciÃ³n**: ${DATE}  
          **Tipo**: Nueva VersiÃ³n  
          **VersiÃ³n anterior**: ${PREV_VERSION}
          
          ## ðŸš€ Resumen Ejecutivo
          
          Esta versiÃ³n introduce nuevas funcionalidades y mejoras significativas al sistema.
          
          ## âœ¨ Funcionalidades Nuevas
          
          $(git log --pretty=format:"- **%s** (%h)" --grep="^feat" ${PREV_VERSION}..HEAD 2>/dev/null || echo "- Sin funcionalidades nuevas")
          
          ## ðŸ› Correcciones
          
          $(git log --pretty=format:"- %s (%h)" --grep="^fix" ${PREV_VERSION}..HEAD 2>/dev/null || echo "- Sin correcciones")
          
          ## âš¡ Mejoras de Performance
          
          $(git log --pretty=format:"- %s (%h)" --grep="^perf" ${PREV_VERSION}..HEAD 2>/dev/null || echo "- Sin mejoras de performance")
          
          ## ðŸ”§ Cambios TÃ©cnicos
          
          $(git log --pretty=format:"- %s (%h)" --grep="^refactor" ${PREV_VERSION}..HEAD 2>/dev/null || echo "- Sin cambios tÃ©cnicos")
          
          ## ðŸ“Š EstadÃ­sticas
          
          - **Commits**: $(git rev-list --count ${PREV_VERSION}..HEAD 2>/dev/null || echo "N/A")
          - **Archivos modificados**: $(git diff --name-only ${PREV_VERSION}..HEAD 2>/dev/null | wc -l || echo "N/A")
          - **Colaboradores**: $(git log --format='%an' ${PREV_VERSION}..HEAD 2>/dev/null | sort -u | wc -l || echo "N/A")
          
          ## ðŸ”„ Requerimientos de MigraciÃ³n
          
          $(if [ "${{ steps.analyze.outputs.has_breaking }}" -gt 0 ]; then echo "âš ï¸ Esta versiÃ³n contiene cambios incompatibles. Ver detalles en CHANGELOG.md"; else echo "âœ… No requiere migraciÃ³n"; fi)
          
          ## ðŸ“ Mejoras Aplicadas
          
          Ver [mejoras.md](mejoras.md) para el historial de mejoras incrementales.
          
          ---
          *DocumentaciÃ³n generada automÃ¡ticamente el ${DATE}*
          EOF
          
            # Crear archivo de mejoras vacÃ­o
            echo "# Mejoras de la versiÃ³n ${VERSION}" > "documentos/versiones/${VERSION}/mejoras.md"
            echo "" >> "documentos/versiones/${VERSION}/mejoras.md"
            echo "Esta secciÃ³n registra las mejoras incrementales aplicadas a esta versiÃ³n." >> "documentos/versiones/${VERSION}/mejoras.md"
          else
            # Mejora incremental
            cat >> "documentos/versiones/${VERSION}/mejoras.md" << EOF
          
          ## Mejora del ${DATE}
          
          **PR**: #${{ github.event.pull_request.number }}
          
          ### Cambios
          $(git log --pretty=format:"- %s" ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }})
          
          ---
          EOF
          fi

      - name: Update Documentation Home
        run: |
          VERSION="${{ steps.version.outputs.current }}"
          DATE=$(date +%Y-%m-%d)
          
          # Contar documentos
          PR_COUNT=$(find documentos/prs -name "PR-*.md" 2>/dev/null | wc -l || echo "0")
          VERSION_COUNT=$(find documentos/versiones -maxdepth 1 -type d 2>/dev/null | wc -l || echo "1")
          FEATURE_COUNT=$(find documentos/funcionalidades -name "*.md" 2>/dev/null | wc -l || echo "0")
          
          # Obtener Ãºltimas features
          LATEST_FEATURES=$(find documentos/funcionalidades -name "*.md" -type f 2>/dev/null | head -5 | xargs -I {} basename {} .md | sed 's/-/ /g' | sed 's/\b\(.\)/\u\1/g' || echo "")
          
          cat > documentos/index.md << EOF
          # ðŸ  SistemSo - Centro de DocumentaciÃ³n
          
          Bienvenido al centro de documentaciÃ³n del proyecto SistemSo. AquÃ­ encontrarÃ¡s toda la informaciÃ³n tÃ©cnica y funcional del sistema, actualizada automÃ¡ticamente.
          
          ---
          
          ## ðŸ“Š Estado del Proyecto
          
          | MÃ©trica | Valor |
          |---------|-------|
          | **VersiÃ³n Actual** | ${VERSION} |
          | **Ãšltima ActualizaciÃ³n** | ${DATE} |
          | **Pull Requests Documentados** | ${PR_COUNT} |
          | **Versiones Liberadas** | ${VERSION_COUNT} |
          | **Funcionalidades** | ${FEATURE_COUNT} |
          
          ---
          
          ## ðŸ—‚ï¸ NavegaciÃ³n
          
          ### ðŸ“ DocumentaciÃ³n TÃ©cnica
          
          **[Arquitectura del Sistema](arquitectura/ARQUITECTURA_v1.0_2025-02-06.md)**  
          Stack tecnolÃ³gico, patrones de diseÃ±o, arquitectura de deployment y sistema de mensajerÃ­a en tiempo real.  
          *Ãšltima actualizaciÃ³n: 2025-02-06*
          
          **[Convenciones de Commits](CONVENCIONES_COMMITS.md)**  
          GuÃ­a completa de Conventional Commits para mantener un historial claro y generar documentaciÃ³n automÃ¡tica.  
          *Ãšltima actualizaciÃ³n: ${DATE}*
          
          ---
          
          ### ðŸ”€ Pull Requests
          
          **[Ver todos los PRs â†’](prs/index.md)**
          
          DocumentaciÃ³n detallada de cada Pull Request, incluyendo:
          - MÃ³dulos afectados
          - Archivos modificados
          - EstadÃ­sticas de cambios
          - Impacto funcional
          
          ðŸ“ˆ **Total documentados**: ${PR_COUNT} PRs
          
          ---
          
          ### ðŸš€ Versiones del Sistema
          
          **[Ver historial de versiones â†’](versiones/index.md)**
          
          #### Ãšltima VersiÃ³n: ${VERSION}
          
          Liberada el ${DATE}
          
          **CaracterÃ­sticas principales:**
          - Sistema de documentaciÃ³n automÃ¡tica
          - Versionado semÃ¡ntico
          - Workflows de CI/CD
          - Sitio de documentaciÃ³n web
          
          [ðŸ“– Ver documentaciÃ³n completa de ${VERSION} â†’](versiones/${VERSION}/index.md)
          
          ---
          
          ### âœ¨ Funcionalidades Recientes
          
          $(if [ -n "$LATEST_FEATURES" ]; then echo "$LATEST_FEATURES" | while read -r feature; do echo "- $feature"; done; else echo "- Sistema de documentaciÃ³n automÃ¡tica"; fi)
          
          [ðŸ” Ver todas las funcionalidades â†’](funcionalidades/index.md)
          
          ---
          
          ### ðŸ§¾ CHANGELOG
          
          **[Ver CHANGELOG completo â†’](../CHANGELOG.md)**
          
          Registro cronolÃ³gico de todos los cambios del proyecto, actualizado automÃ¡ticamente con cada release.
          
          ---
          
          ## ðŸŽ¯ GuÃ­as RÃ¡pidas
          
          ### Para Desarrolladores
          
          1. **[CÃ³mo hacer commits](CONVENCIONES_COMMITS.md#formato)** - Formato de commits
          2. **[Crear Pull Request](README.md#para-desarrolladores)** - Flujo de trabajo
          3. **[Arquitectura](arquitectura/ARQUITECTURA_v1.0_2025-02-06.md)** - Entender el sistema
          
          ### Para QA/Negocio
          
          1. **[Versiones](versiones/index.md)** - QuÃ© cambiÃ³ en cada versiÃ³n
          2. **[Funcionalidades](funcionalidades/index.md)** - Nuevas features
          3. **[CHANGELOG](../CHANGELOG.md)** - Resumen de cambios
          
          ---
          
          ## ðŸ”„ ActualizaciÃ³n AutomÃ¡tica
          
          Esta documentaciÃ³n se actualiza automÃ¡ticamente cuando:
          
          - âœ… Se abre o actualiza un Pull Request
          - âœ… Se hace merge a la rama principal
          - âœ… Se libera una nueva versiÃ³n
          - âœ… Se agregan nuevas funcionalidades
          
          **No requiere mantenimiento manual.**
          
          ---
          
          ## ðŸ“š Recursos Adicionales
          
          - [GitHub Repository](https://github.com/Mkdir-arg/SistemSo)
          - [Sistema de DocumentaciÃ³n](README.md)
          - [Conventional Commits](https://www.conventionalcommits.org/)
          - [Semantic Versioning](https://semver.org/)
          
          ---
          
          *DocumentaciÃ³n generada automÃ¡ticamente el ${DATE}*  
          *VersiÃ³n del sistema: ${VERSION}*
          EOF

      - name: Create Features Index
        run: |
          mkdir -p documentos/funcionalidades
          
          cat > documentos/funcionalidades/index.md << 'EOF'
          # âœ¨ Funcionalidades
          
          CatÃ¡logo completo de funcionalidades del sistema, organizadas por versiÃ³n.
          
          ## CÃ³mo se Documenta
          
          Cada funcionalidad se documenta automÃ¡ticamente cuando:
          - Se hace merge de un PR con commits tipo `feat`
          - Se genera una nueva versiÃ³n del sistema
          
          ## Estructura
          
          Cada funcionalidad incluye:
          - **MÃ³dulo**: Componente del sistema afectado
          - **VersiÃ³n**: En quÃ© versiÃ³n se introdujo
          - **DescripciÃ³n funcional**: QuÃ© hace
          - **DescripciÃ³n tÃ©cnica**: CÃ³mo funciona
          - **Impacto**: QuÃ© cambia en el sistema
          - **Referencias**: PR y versiÃ³n asociados
          
          ## Funcionalidades por MÃ³dulo
          
          Las funcionalidades se organizan por mÃ³dulo del sistema:
          - `conversaciones`: Sistema de mensajerÃ­a
          - `legajos`: GestiÃ³n de legajos
          - `dashboard`: Panel de control
          - `core`: Funcionalidad central
          - `users`: Sistema de usuarios
          - `chatbot`: Bot de conversaciÃ³n
          - `tramites`: GestiÃ³n de trÃ¡mites
          - `portal`: Portal pÃºblico
          - `configuracion`: ConfiguraciÃ³n
          
          ---
          
          *Esta pÃ¡gina se actualiza automÃ¡ticamente*
          EOF

      - name: Commit Documentation
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add documentos/
          git commit -m "docs: actualizar documentaciÃ³n post-merge PR #${{ github.event.pull_request.number }} [skip ci]" || echo "No changes"
          git push || echo "Nothing to push"
