name: PR Documentation

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  generate-pr-doc:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.head_ref }}

      - name: Generate PR Documentation
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}
          PR_TITLE="${{ github.event.pull_request.title }}"
          PR_AUTHOR="${{ github.event.pull_request.user.login }}"
          PR_DATE=$(date +%Y-%m-%d)
          
          mkdir -p documentos/prs
          
          MODULES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | cut -d'/' -f1 | sort -u | grep -v '^\..*' | tr '\n' ', ' | sed 's/,$//')
          
          CHANGE_TYPE="fix"
          if echo "$PR_TITLE" | grep -qiE "^feat|^feature"; then
            CHANGE_TYPE="feat"
          elif echo "$PR_TITLE" | grep -qiE "^breaking|BREAKING CHANGE"; then
            CHANGE_TYPE="breaking"
          fi
          
          cat > documentos/prs/PR-${PR_NUMBER}.md << 'EOF'
          # Pull Request #${PR_NUMBER}
          
          ## Información General
          - **Título**: ${PR_TITLE}
          - **Autor**: ${PR_AUTHOR}
          - **Fecha**: ${PR_DATE}
          - **Tipo**: ${CHANGE_TYPE}
          - **Estado**: En revisión
          
          ## Módulos Afectados
          ${MODULES}
          
          ## Descripción
          ${{ github.event.pull_request.body }}
          
          ## Archivos Modificados
          ```
          $(git diff --name-only origin/${{ github.base_ref }}...HEAD)
          ```
          
          ## Estadísticas
          - **Commits**: $(git rev-list --count origin/${{ github.base_ref }}...HEAD)
          - **Archivos**: $(git diff --name-only origin/${{ github.base_ref }}...HEAD | wc -l)
          
          ## Impacto Funcional
          - [ ] Nueva funcionalidad
          - [ ] Corrección de bug
          - [ ] Refactorización
          - [ ] Cambio incompatible
          - [ ] Actualización de documentación
          
          ## Checklist de Revisión
          - [ ] Código revisado
          - [ ] Tests ejecutados
          - [ ] Documentación actualizada
          - [ ] Sin conflictos
          - [ ] Aprobado por revisor
          
          ---
          *Generado automáticamente el ${PR_DATE}*
          EOF
          
      - name: Commit PR Documentation
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add documentos/prs/ || true
          git commit -m "docs: generar documentación PR #${{ github.event.pull_request.number }}" || echo "No changes"
          git push || echo "Nothing to push"
