{% extends "includes/base.html" %}
{% load static %}

{% block title %}Consultar RENAPER{% endblock %}

{% block main-content %}
<div class="max-w-2xl mx-auto">
    <!-- Header -->
    <div class="bg-white rounded-2xl shadow-sm border border-[#E5E7EB] p-8 mb-6">
        <div class="flex items-center gap-4 mb-3">
            <div class="w-14 h-14 bg-gradient-to-br from-[#3B82F6] to-[#2563EB] rounded-2xl flex items-center justify-center shadow-lg">
                <i class="fas fa-user-plus text-white text-xl"></i>
            </div>
            <div>
                <h1 class="text-3xl font-bold text-[#252F40]">Nuevo Ciudadano</h1>
                <p class="text-[#8C8C8C] text-sm">Consulta automática con RENAPER</p>
            </div>
        </div>
    </div>

    <!-- Formulario -->
    <div class="bg-white rounded-2xl shadow-sm border border-[#E5E7EB] overflow-hidden">
        <form method="post" class="p-8 space-y-6">
            {% csrf_token %}
            
            {% if renaper_error %}
                <div class="bg-[#FEF2F2] border-l-4 border-[#EF4444] rounded-lg p-4">
                    <div class="flex items-start gap-3">
                        <i class="fas fa-exclamation-circle text-[#EF4444] text-lg mt-0.5"></i>
                        <div class="flex-1">
                            <p class="text-sm text-[#7F1D1D] font-medium mb-3">{{ error_message }}</p>
                            <div class="flex gap-3">
                                <a href="{% url 'legajos:ciudadano_manual' %}?dni={{ dni_consultado }}&sexo={{ sexo_consultado }}" 
                                   class="text-sm font-medium text-[#EF4444] hover:text-[#DC2626] underline">
                                    Cargar manualmente
                                </a>
                                <button type="button" onclick="location.reload()" 
                                        class="text-sm font-medium text-[#8C8C8C] hover:text-[#4A5565]">
                                    Reintentar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            {% endif %}
            
            {% if form.errors %}
                <div class="bg-[#FEF2F2] border-l-4 border-[#EF4444] rounded-lg p-4">
                    <div class="flex items-start gap-3">
                        <i class="fas fa-exclamation-circle text-[#EF4444] text-lg"></i>
                        <div class="text-sm text-[#7F1D1D]">
                            {% for field, errors in form.errors.items %}
                                {% for error in errors %}
                                    <p>{{ error }}</p>
                                {% endfor %}
                            {% endfor %}
                        </div>
                    </div>
                </div>
            {% endif %}

            <div class="grid grid-cols-2 gap-6">
                <div>
                    <label for="{{ form.dni.id_for_label }}" class="block text-sm font-semibold text-[#252F40] mb-2">
                        DNI <span class="text-[#EF4444]">*</span>
                    </label>
                    <input type="text" name="dni" id="{{ form.dni.id_for_label }}" 
                           class="w-full px-4 py-3 border border-[#E5E7EB] rounded-xl focus:ring-2 focus:ring-[#3B82F6] focus:border-transparent transition-all" 
                           placeholder="12345678" required>
                </div>

                <div>
                    <label for="{{ form.sexo.id_for_label }}" class="block text-sm font-semibold text-[#252F40] mb-2">
                        Sexo <span class="text-[#EF4444]">*</span>
                    </label>
                    <select name="sexo" id="{{ form.sexo.id_for_label }}" 
                            class="w-full px-4 py-3 border border-[#E5E7EB] rounded-xl focus:ring-2 focus:ring-[#3B82F6] focus:border-transparent transition-all" required>
                        <option value="">Seleccionar...</option>
                        <option value="M">Masculino</option>
                        <option value="F">Femenino</option>
                    </select>
                </div>
            </div>

            <div class="flex items-center justify-between pt-6">
                <a href="{% url 'legajos:ciudadanos' %}" 
                   class="text-[#8C8C8C] hover:text-[#4A5565] font-medium transition-colors">
                    ← Volver
                </a>
                
                <button type="submit" 
                        class="px-8 py-3 bg-gradient-to-r from-[#3B82F6] to-[#2563EB] text-white font-semibold rounded-xl hover:shadow-lg transition-all">
                    Consultar RENAPER
                </button>
            </div>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Validación del CUIT
    const cuitInput = document.getElementById('{{ form.cuit.id_for_label }}');
    if (cuitInput) {
        cuitInput.addEventListener('input', function(e) {
            // Obtener solo números
            let numbers = e.target.value.replace(/\D/g, '');
            
            // Limitar a 11 dígitos
            if (numbers.length > 11) {
                numbers = numbers.slice(0, 11);
            }
            
            // Formatear automáticamente XX-XXXXXXXX-X
            let formatted = '';
            if (numbers.length > 0) {
                if (numbers.length <= 2) {
                    formatted = numbers;
                } else if (numbers.length <= 10) {
                    formatted = numbers.slice(0, 2) + '-' + numbers.slice(2);
                } else {
                    formatted = numbers.slice(0, 2) + '-' + numbers.slice(2, 10) + '-' + numbers.slice(10);
                }
            }
            
            e.target.value = formatted;
        });
        
        // Validar formato al perder el foco
        cuitInput.addEventListener('blur', function(e) {
            const value = e.target.value.replace(/\D/g, '');
            if (value.length > 0 && value.length !== 11) {
                e.target.setCustomValidity('El CUIT debe tener 11 dígitos');
            } else {
                e.target.setCustomValidity('');
            }
        });
    }
});
</script>
{% endblock %}
