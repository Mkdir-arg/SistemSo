import React, { useState, useRef } from 'react';
import { View, Text, StyleSheet, ScrollView, TextInput, Pressable, Platform, TouchableOpacity, Dimensions, Image, Modal } from 'react-native';
import SignaturePad from '../components/SignaturePad';
import { useTheme } from '../context/ThemeContext';
import { Ionicons } from '@expo/vector-icons';
import { LinearGradient } from 'expo-linear-gradient';
import MaskedView from '@react-native-masked-view/masked-view';
import StaggeredItem from '../components/StaggeredItem';
import CustomButton from '../components/CustomButton';

const { width } = Dimensions.get('window');

const GradientIcon = ({ name, size = 24, style }) => {
    return (
        <View style={[{ width: size, height: size }, style]}>
            <MaskedView
                style={{ flex: 1 }}
                maskElement={
                    <View style={{ backgroundColor: 'transparent', justifyContent: 'center', alignItems: 'center', flex: 1 }}>
                        <Ionicons name={name} size={size} color="black" />
                    </View>
                }
            >
                <LinearGradient
                    colors={['#FF0080', '#7928CA']}
                    start={{ x: 0, y: 0 }}
                    end={{ x: 0, y: 1 }}
                    style={{ flex: 1 }}
                />
            </MaskedView>
        </View>
    );
};

export default function VulnerabilitySurveyScreen({ onCancel, onSave }) {
    const { theme, typography } = useTheme();
    const [currentStep, setCurrentStep] = useState(1);
    const [images, setImages] = useState([]);
    const [signature, setSignature] = useState([]);
    const [showSigModal, setShowSigModal] = useState(false);
    const signaturePadRef = useRef(null);

    const [formData, setFormData] = useState({
        jefeHogar: '',
        miembros: '1',
        tipoVivienda: 'Casa',
        materialPared: '',
        materialTecho: '',
        agua: 'Red pública',
        gas: 'Garrafa',
        electricidad: 'Con medidor',
        hacinamiento: false,
        observaciones: '',
        lat: '-34.6037',
        lng: '-58.3816'
    });

    const steps = [
        { id: 1, title: 'Persona', icon: 'person' },
        { id: 2, title: 'Territorio', icon: 'map' },
        { id: 3, title: 'Vivienda', icon: 'home' },
        { id: 4, title: 'Evidencia', icon: 'camera' },
        { id: 5, title: 'Cierre', icon: 'checkmark-circle' }
    ];

    const nextStep = () => {
        if (currentStep < 5) setCurrentStep(currentStep + 1);
        else onSave();
    };

    const prevStep = () => {
        if (currentStep > 1) setCurrentStep(currentStep - 1);
    };

    const addMockImage = () => {
        if (images.length < 6) {
            setImages([...images, { id: Date.now(), uri: 'https://picsum.photos/200/200' }]);
        }
    };

    const removeImage = (id) => {
        setImages(images.filter(img => img.id !== id));
    };

    const renderInput = (label, placeholder, key, icon, multiline = false) => (
        <View style={styles.inputGroup}>
            <Text style={[styles.label, { color: theme.colors.text, fontFamily: typography.semibold }]}>{label}</Text>
            <View style={[styles.inputWrapper, { backgroundColor: theme.colors.surface, borderColor: theme.colors.border }]}>
                <Ionicons name={icon} size={20} color={theme.colors.primary} style={styles.inputIcon} />
                <TextInput
                    style={[styles.input, { color: theme.colors.text, fontFamily: typography.regular, height: multiline ? 100 : 50 }]}
                    placeholder={placeholder}
                    placeholderTextColor={theme.colors.textSoft}
                    value={formData[key]}
                    onChangeText={(text) => setFormData({ ...formData, [key]: text })}
                    multiline={multiline}
                />
            </View>
        </View>
    );

    const renderSelector = (label, options, key) => (
        <View style={styles.inputGroup}>
            <Text style={[styles.label, { color: theme.colors.text, fontFamily: typography.semibold }]}>{label}</Text>
            <View style={styles.optionsRow}>
                {options.map(opt => (
                    <TouchableOpacity
                        key={opt}
                        onPress={() => setFormData({ ...formData, [key]: opt })}
                        style={[
                            styles.optionChip,
                            { backgroundColor: theme.colors.surface, borderColor: theme.colors.border },
                            formData[key] === opt && { backgroundColor: theme.colors.primary, borderColor: theme.colors.primary }
                        ]}
                    >
                        <Text style={[
                            styles.optionText,
                            { color: theme.colors.text, fontFamily: typography.medium },
                            formData[key] === opt && { color: '#FFF' }
                        ]}>
                            {opt}
                        </Text>
                    </TouchableOpacity>
                ))}
            </View>
        </View>
    );

    const renderStepContent = () => {
        switch (currentStep) {
            case 1:
                return (
                    <View style={styles.stepContainer}>
                        <StaggeredItem index={0}>
                            <Text style={[styles.stepTitle, { color: theme.colors.text, fontFamily: typography.bold }]}>Referente Familiar</Text>
                            <Text style={[styles.stepDesc, { color: theme.colors.textSoft, fontFamily: typography.regular }]}>Registre los datos básicos del titular del hogar para el legajo 360.</Text>
                        </StaggeredItem>
                        <StaggeredItem index={1}>{renderInput('Jefe/a de Hogar', 'Nombre completo', 'jefeHogar', 'person')}</StaggeredItem>
                        <StaggeredItem index={2}>{renderInput('Personas en el Hogar', 'Ej: 5', 'miembros', 'people')}</StaggeredItem>
                    </View>
                );
            case 2:
                return (
                    <View style={styles.stepContainer}>
                        <StaggeredItem index={0}>
                            <Text style={[styles.stepTitle, { color: theme.colors.text, fontFamily: typography.bold }]}>Geolocalización NODO</Text>
                            <Text style={[styles.stepDesc, { color: theme.colors.textSoft, fontFamily: typography.regular }]}>El punto exacto del relevamiento garantiza la trazabilidad territorial.</Text>
                        </StaggeredItem>

                        <StaggeredItem index={1}>
                            <View style={[styles.mapMock, { backgroundColor: theme.colors.surfaceAlt, borderColor: theme.colors.border }]}>
                                <Ionicons name="map" size={40} color={theme.colors.textSoft} style={{ opacity: 0.2 }} />
                                <View style={[styles.mapPin, { backgroundColor: theme.colors.primary }]}>
                                    <Ionicons name="location" size={24} color="#FFF" />
                                </View>
                                <View style={styles.mapControls}>
                                    <View style={[styles.mapControlBtn, { backgroundColor: theme.colors.surface }]}><Ionicons name="add" size={20} color={theme.colors.text} /></View>
                                    <View style={[styles.mapControlBtn, { backgroundColor: theme.colors.surface }]}><Ionicons name="remove" size={20} color={theme.colors.text} /></View>
                                </View>
                            </View>
                            <View style={styles.coordsRow}>
                                <View style={[styles.coordBadge, { backgroundColor: theme.colors.surface }]}>
                                    <Text style={[styles.coordLabel, { color: theme.colors.textSoft, fontFamily: typography.medium }]}>LAT:</Text>
                                    <Text style={[styles.coordValue, { color: theme.colors.text, fontFamily: typography.bold }]}>{formData.lat}</Text>
                                </View>
                                <View style={[styles.coordBadge, { backgroundColor: theme.colors.surface }]}>
                                    <Text style={[styles.coordLabel, { color: theme.colors.textSoft, fontFamily: typography.medium }]}>LNG:</Text>
                                    <Text style={[styles.coordValue, { color: theme.colors.text, fontFamily: typography.bold }]}>{formData.lng}</Text>
                                </View>
                            </View>
                        </StaggeredItem>
                    </View>
                );
            case 3:
                return (
                    <View style={styles.stepContainer}>
                        <StaggeredItem index={0}>
                            <Text style={[styles.stepTitle, { color: theme.colors.text, fontFamily: typography.bold }]}>Infraestructura</Text>
                        </StaggeredItem>
                        <StaggeredItem index={1}>{renderSelector('Tipo de Vivienda', ['Casa', 'Casilla', 'Rancho', 'Pieza'], 'tipoVivienda')}</StaggeredItem>
                        <StaggeredItem index={2}>{renderSelector('Servicio de Agua', ['Red', 'Pozo', 'Camión'], 'agua')}</StaggeredItem>
                        <StaggeredItem index={3}>{renderSelector('Electricidad', ['Formal', 'Irregular'], 'electricidad')}</StaggeredItem>
                    </View>
                );
            case 4:
                return (
                    <View style={styles.stepContainer}>
                        <StaggeredItem index={0}>
                            <Text style={[styles.stepTitle, { color: theme.colors.text, fontFamily: typography.bold }]}>Evidencia Fotográfica</Text>
                            <Text style={[styles.stepDesc, { color: theme.colors.textSoft, fontFamily: typography.regular }]}>Capture imágenes de la vivienda y del entorno para documentar el estado real.</Text>
                        </StaggeredItem>

                        <StaggeredItem index={1}>
                            <View style={styles.imageGrid}>
                                <TouchableOpacity
                                    onPress={addMockImage}
                                    style={[styles.imageAddBtn, { backgroundColor: theme.colors.surface, borderColor: theme.colors.primary, borderStyle: 'dashed' }]}
                                >
                                    <Ionicons name="camera" size={32} color={theme.colors.primary} />
                                    <Text style={[styles.imageAddText, { color: theme.colors.primary, fontFamily: typography.bold }]}>AGREGAR FOTO</Text>
                                    <Text style={[styles.imageLimitText, { color: theme.colors.textSoft, fontFamily: typography.medium }]}>{images.length}/6</Text>
                                </TouchableOpacity>

                                {images.map(img => (
                                    <View key={img.id} style={styles.imageItem}>
                                        <Image source={{ uri: img.uri }} style={styles.imageThumb} />
                                        <TouchableOpacity
                                            onPress={() => removeImage(img.id)}
                                            style={styles.imageRemoveBtn}
                                        >
                                            <Ionicons name="close-circle" size={24} color="#EA0606" />
                                        </TouchableOpacity>
                                    </View>
                                ))}
                            </View>
                        </StaggeredItem>
                    </View>
                );
            case 5:
                return (
                    <View style={styles.stepContainer}>
                        <StaggeredItem index={0}>
                            <Text style={[styles.stepTitle, { color: theme.colors.text, fontFamily: typography.bold }]}>Validación y Firma</Text>
                        </StaggeredItem>

                        <StaggeredItem index={1}>
                            <View style={[styles.vulnerabilityCard, { backgroundColor: theme.colors.primary + '15' }]}>
                                <Ionicons name="shield-checkmark" size={32} color={theme.colors.primary} />
                                <View style={styles.vulnerabilityInfo}>
                                    <Text style={[styles.vulnerabilityLabel, { color: theme.colors.text, fontFamily: typography.bold }]}>Índice NODO</Text>
                                    <Text style={[styles.vulnerabilityValue, { color: theme.colors.primary, fontFamily: typography.extrabold }]}>8.2 - Crítico</Text>
                                </View>
                            </View>
                        </StaggeredItem>

                        <StaggeredItem index={2}>
                            <Text style={[styles.label, { color: theme.colors.text, fontFamily: typography.semibold, marginTop: 10 }]}>Firma del Declarante</Text>
                            <TouchableOpacity
                                onPress={() => setShowSigModal(true)}
                                style={[styles.signatureArea, { backgroundColor: theme.colors.surface, borderColor: theme.colors.border }]}
                            >
                                {signature.length > 0 ? (
                                    <View style={styles.signaturePreview}>
                                        <Ionicons name="checkmark-circle" size={32} color="#2DCE89" />
                                        <Text style={[styles.signatureHint, { color: '#2DCE89', fontFamily: typography.bold }]}>Firma capturada</Text>
                                    </View>
                                ) : (
                                    <>
                                        <Ionicons name="pencil" size={32} color={theme.colors.primary} style={{ opacity: 0.3 }} />
                                        <Text style={[styles.signatureHint, { color: theme.colors.textSoft, fontFamily: typography.medium }]}>Toca aquí para firmar</Text>
                                    </>
                                )}
                            </TouchableOpacity>

                            {/* Modal para la Firma */}
                            <Modal visible={showSigModal} animationType="slide" transparent={true}>
                                <View style={styles.modalOverlay}>
                                    <View style={styles.modalContent}>
                                        <View style={styles.sigModalHeader}>
                                            <Text style={{ fontFamily: typography.bold, fontSize: 18, color: '#000' }}>FIRMA DIGITAL</Text>
                                            <TouchableOpacity
                                                onPress={() => setShowSigModal(false)}
                                                style={styles.closeButton}
                                            >
                                                <Ionicons name="close" size={40} color="#FF0080" />
                                            </TouchableOpacity>
                                        </View>

                                        <SignaturePad
                                            ref={signaturePadRef}
                                            onEnd={(paths) => setSignature(paths)}
                                        />

                                        <View style={styles.sigModalFooter}>
                                            <CustomButton
                                                title="Limpiar"
                                                onPress={() => {
                                                    setSignature([]);
                                                    if (signaturePadRef.current) {
                                                        signaturePadRef.current.clear();
                                                    }
                                                }}
                                                disabled={false}
                                                iconLeft="trash-outline"
                                                size="Base"
                                                variant="secondary"
                                                style={{ flex: 1 }}
                                            />

                                            <CustomButton
                                                title="Confirmar"
                                                onPress={() => setShowSigModal(false)}
                                                iconRight="checkmark"
                                                size="Base"
                                                style={{ flex: 1 }}
                                            />
                                        </View>
                                    </View>
                                </View>
                            </Modal>
                        </StaggeredItem>

                        <StaggeredItem index={3}>
                            {renderInput('Observaciones Finales', 'Escriba un breve resumen...', 'observaciones', 'create', true)}
                        </StaggeredItem>
                    </View>
                );
        }
    };

    return (
        <View style={[styles.container, { backgroundColor: theme.colors.background }]}>
            <View style={[styles.header, { borderBottomColor: theme.colors.border }]}>
                <TouchableOpacity onPress={onCancel} style={styles.closeBtn}>
                    <Ionicons name="close" size={28} color={theme.colors.text} />
                </TouchableOpacity>
                <Text style={[styles.headerTitle, { color: theme.colors.text, fontFamily: typography.bold }]}>RELEVAMIENTO TERRITORIAL</Text>
                <View style={{ width: 28 }} />
            </View>

            {/* Steps Indicator */}
            <View style={styles.stepperScroll}>
                <ScrollView horizontal showsHorizontalScrollIndicator={false} contentContainerStyle={styles.stepper}>
                    {steps.map((s, idx) => (
                        <React.Fragment key={s.id}>
                            <View style={styles.stepNode}>
                                <View style={[
                                    styles.stepIconCircle,
                                    { backgroundColor: theme.colors.surface, borderColor: theme.colors.border },
                                    currentStep >= s.id && { backgroundColor: theme.colors.primary, borderColor: theme.colors.primary }
                                ]}>
                                    <Ionicons name={s.icon} size={14} color={currentStep >= s.id ? '#FFF' : theme.colors.textSoft} />
                                </View>
                                <Text style={[
                                    styles.stepNodeLabel,
                                    { color: theme.colors.textSoft, fontFamily: typography.medium },
                                    currentStep === s.id && { color: theme.colors.primary, fontFamily: typography.bold }
                                ]}>{s.title}</Text>
                            </View>
                            {idx < steps.length - 1 && (
                                <View style={[styles.stepConnect, { backgroundColor: theme.colors.border }, currentStep > s.id && { backgroundColor: theme.colors.primary }]} />
                            )}
                        </React.Fragment>
                    ))}
                </ScrollView>
            </View>

            <ScrollView contentContainerStyle={styles.scrollBody}>
                {renderStepContent()}
            </ScrollView>

            <View style={[styles.footer, { borderTopColor: theme.colors.border }]}>
                {currentStep > 1 && (
                    <CustomButton
                        title="ANTERIOR"
                        onPress={prevStep}
                        iconLeft="chevron-back"
                        size="L"
                        variant="secondary"
                        style={{ flex: 1, marginRight: 12 }}
                    />
                )}
                <CustomButton
                    title={currentStep === 5 ? 'FINALIZAR Y ENVIAR' : 'SIGUIENTE'}
                    onPress={nextStep}
                    iconRight={currentStep === 5 ? "cloud-upload" : "chevron-forward"}
                    size="L"
                    style={{ flex: 1.5 }}
                />
            </View>
        </View>
    );
}

const styles = StyleSheet.create({
    container: {
        flex: 1,
    },
    header: {
        paddingTop: Platform.OS === 'ios' ? 60 : 40,
        paddingBottom: 20,
        paddingHorizontal: 20,
        flexDirection: 'row',
        alignItems: 'center',
        justifyContent: 'space-between',
        borderBottomWidth: 1,
    },
    headerTitle: {
        fontSize: 13,
        letterSpacing: 2,
    },
    stepperScroll: {
        backgroundColor: 'rgba(0,0,0,0.02)',
    },
    stepper: {
        paddingHorizontal: 20,
        paddingVertical: 15,
        alignItems: 'center',
    },
    stepNode: {
        alignItems: 'center',
        width: 60,
    },
    stepIconCircle: {
        width: 32,
        height: 32,
        borderRadius: 16,
        borderWidth: 2,
        justifyContent: 'center',
        alignItems: 'center',
        marginBottom: 4,
    },
    stepNodeLabel: {
        fontSize: 8,
        textTransform: 'uppercase',
    },
    stepConnect: {
        width: 20,
        height: 2,
        marginTop: -15,
        marginHorizontal: 5,
    },
    scrollBody: {
        padding: 24,
    },
    stepContainer: {
        minHeight: 400,
    },
    stepTitle: {
        fontSize: 24,
        marginBottom: 8,
    },
    stepDesc: {
        fontSize: 14,
        lineHeight: 20,
        marginBottom: 24,
    },
    mapMock: {
        height: 200,
        borderRadius: 24,
        borderWidth: 1,
        marginBottom: 16,
        justifyContent: 'center',
        alignItems: 'center',
        overflow: 'hidden',
    },
    mapPin: {
        width: 44,
        height: 44,
        borderRadius: 22,
        justifyContent: 'center',
        alignItems: 'center',
        shadowColor: '#000',
        shadowOffset: { width: 0, height: 4 },
        shadowOpacity: 0.3,
        shadowRadius: 5,
        elevation: 6,
    },
    mapControls: {
        position: 'absolute',
        right: 15,
        bottom: 15,
    },
    mapControlBtn: {
        width: 36,
        height: 36,
        borderRadius: 10,
        justifyContent: 'center',
        alignItems: 'center',
        marginBottom: 8,
        shadowColor: '#000',
        shadowOffset: { width: 0, height: 2 },
        shadowOpacity: 0.1,
        shadowRadius: 3,
        elevation: 3,
    },
    coordsRow: {
        flexDirection: 'row',
        justifyContent: 'space-between',
        marginBottom: 24,
    },
    coordBadge: {
        width: '48%',
        padding: 12,
        borderRadius: 16,
        flexDirection: 'row',
        alignItems: 'center',
    },
    coordLabel: {
        fontSize: 10,
        marginRight: 8,
    },
    coordValue: {
        fontSize: 13,
    },
    imageGrid: {
        flexDirection: 'row',
        flexWrap: 'wrap',
        justifyContent: 'space-between',
    },
    imageAddBtn: {
        width: '48%',
        aspectRatio: 1,
        borderRadius: 24,
        borderWidth: 2,
        justifyContent: 'center',
        alignItems: 'center',
        marginBottom: 16,
    },
    imageAddText: {
        fontSize: 10,
        marginTop: 8,
    },
    imageLimitText: {
        fontSize: 9,
        marginTop: 2,
    },
    imageItem: {
        width: '48%',
        aspectRatio: 1,
        borderRadius: 24,
        marginBottom: 16,
        overflow: 'hidden',
    },
    imageThumb: {
        width: '100%',
        height: '100%',
    },
    imageRemoveBtn: {
        position: 'absolute',
        top: 8,
        right: 8,
    },
    vulnerabilityCard: {
        flexDirection: 'row',
        padding: 24,
        borderRadius: 24,
        alignItems: 'center',
        marginBottom: 24,
    },
    vulnerabilityInfo: {
        marginLeft: 16,
    },
    vulnerabilityLabel: {
        fontSize: 12,
        marginBottom: 2,
    },
    vulnerabilityValue: {
        fontSize: 22,
    },
    signatureArea: {
        height: 140,
        borderRadius: 24,
        borderWidth: 1,
        justifyContent: 'center',
        alignItems: 'center',
        marginBottom: 24,
        marginTop: 10,
    },
    signatureHint: {
        fontSize: 11,
        marginTop: 12,
    },
    signaturePreview: {
        justifyContent: 'center',
        alignItems: 'center',
    },
    sigModalHeader: {
        flexDirection: 'row',
        alignItems: 'center',
        justifyContent: 'space-between',
        padding: 20,
        borderBottomWidth: 1,
        borderBottomColor: '#EEE',
    },
    modalOverlay: {
        flex: 1,
        backgroundColor: 'rgba(0,0,0,0.5)',
        justifyContent: 'flex-end',
    },
    modalContent: {
        height: '75%',
        backgroundColor: '#FFF',
        borderTopLeftRadius: 24,
        borderTopRightRadius: 24,
        overflow: 'hidden',
    },
    sigModalFooter: {
        flexDirection: 'row',
        padding: 20,
        paddingBottom: Platform.OS === 'ios' ? 35 : 20,
        gap: 12,
        borderTopWidth: 1,
        borderTopColor: '#EEE',
    },
    closeButton: {
        padding: 4,
    },
    inputGroup: {
        marginBottom: 24,
    },
    label: {
        fontSize: 14,
        marginBottom: 10,
    },
    inputWrapper: {
        flexDirection: 'row',
        alignItems: 'center',
        borderRadius: 18,
        borderWidth: 1,
        paddingHorizontal: 16,
    },
    inputIcon: {
        marginRight: 12,
    },
    input: {
        flex: 1,
        fontSize: 16,
    },
    optionsRow: {
        flexDirection: 'row',
        flexWrap: 'wrap',
    },
    optionChip: {
        paddingHorizontal: 16,
        paddingVertical: 10,
        borderRadius: 12,
        borderWidth: 1,
        marginRight: 8,
        marginBottom: 8,
    },
    optionText: {
        fontSize: 13,
    },
    footer: {
        height: Platform.OS === 'ios' ? 100 : 80,
        paddingHorizontal: 24,
        paddingBottom: Platform.OS === 'ios' ? 30 : 15,
        flexDirection: 'row',
        alignItems: 'center',
        borderTopWidth: 1,
    },
});
