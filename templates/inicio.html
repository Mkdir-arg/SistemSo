{% extends "includes/base.html" %}
{% load static %}
{% load custom_filters %}

{% block title %}Dashboard Ejecutivo{% endblock %}

{% block page_css %}
<link rel="stylesheet" href="{% static 'custom/css/inicio.css' %}" />
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
{% endblock %}

{% block main-content %}
<div class="max-w-full mx-4 lg:mx-8" x-data="dashboard()">
    <!-- Header Dinámico -->
    <div class="bg-[#7928CA] rounded-2xl p-8 mb-8 text-white shadow-lg">
        <div class="flex justify-between items-start">
            <div>
                <h1 class="text-3xl font-bold mb-2" x-text="saludo"></h1>
                <p class="text-purple-100" x-text="fechaHora"></p>
            </div>
            <div class="flex items-center gap-3">
                <div class="px-4 py-2 bg-white/20 rounded-xl flex items-center gap-2">
                    <div class="w-2 h-2 bg-[#08B8CC] rounded-full animate-pulse"></div>
                    <span class="text-sm font-medium">Sistema Activo</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Búsqueda Rápida -->
    <div class="bg-white rounded-xl p-6 mb-8 border border-[#E5E7EB]" style="box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);">
        <div class="flex gap-4 items-center">
            <div class="flex-1 relative">
                <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-[#56606A]"></i>
                <input type="text" placeholder="Buscar ciudadano (mín. 3 caracteres): nombre, apellido, DNI..." 
                       class="w-full pl-12 pr-4 py-3 bg-[#F9FAFB] border border-[#E5E7EB] rounded-xl text-[#101828] placeholder-[#8C8C8C] focus:outline-none focus:ring-2 focus:ring-[#FF0080] focus:border-transparent transition-all"
                       x-model="busqueda" @input="buscarCiudadano()">
            </div>
            <button class="btn-nodo btn-brand btn-base">
                <i class="fas fa-plus"></i>
                <span>Nuevo Legajo</span>
            </button>
        </div>
        <div x-show="resultadosBusqueda.length > 0" class="mt-4 bg-gray-50 rounded-lg p-4 max-h-60 overflow-y-auto">
            <template x-for="resultado in resultadosBusqueda">
                <div class="p-3 hover:bg-white rounded-lg cursor-pointer transition-colors">
                    <div class="font-medium" x-text="resultado.nombre"></div>
                    <div class="text-sm text-gray-500" x-text="'DNI: ' + resultado.dni"></div>
                </div>
            </template>
        </div>
    </div>

    <!-- Alertas Críticas -->
    <div class="bg-red-50 border border-red-200 rounded-xl p-6 mb-8" x-show="alertasCriticas.length > 0">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-semibold text-red-800 flex items-center">
                <i class="fas fa-exclamation-triangle mr-2 animate-pulse"></i>
                Alertas Críticas
            </h3>
            <span class="bg-red-100 text-red-800 px-3 py-1 rounded-full text-sm font-medium" x-text="alertasCriticas.length + ' alertas'"></span>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <template x-for="alerta in alertasCriticas">
                <div class="bg-white border border-red-200 rounded-lg p-4 hover:shadow-md transition-shadow">
                    <div class="flex items-start justify-between">
                        <div>
                            <div class="font-medium text-gray-900" x-text="alerta.ciudadano"></div>
                            <div class="text-sm text-red-600" x-text="alerta.tipo"></div>
                            <div class="text-xs text-gray-500" x-text="alerta.fecha"></div>
                        </div>
                        <button class="text-red-600 hover:text-red-800">
                            <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>
                </div>
            </template>
        </div>
    </div>

    <!-- Métricas Principales con Gráficos -->
    <div class="grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-4 mb-8">
        <div class="bg-white rounded-xl p-5 border border-[#E5E7EB] shadow-sm hover:shadow-md transition-all duration-300">
            <div class="flex items-center justify-between mb-3">
                <i class="fas fa-user-friends text-xl text-[#10B981]"></i>
            </div>
            <p class="text-3xl font-bold mb-1 text-[#252F40]" x-text="metricas.ciudadanos"></p>
            <p class="text-xs text-[#8C8C8C] uppercase tracking-wide">Total Ciudadanos</p>
        </div>

        <div class="bg-white rounded-xl p-5 border border-[#E5E7EB] shadow-sm hover:shadow-md transition-all duration-300">
            <div class="flex items-center justify-between mb-3">
                <i class="fas fa-folder-open text-xl text-[#3B82F6]"></i>
            </div>
            <p class="text-3xl font-bold mb-1 text-[#252F40]" x-text="metricas.legajos"></p>
            <p class="text-xs text-[#8C8C8C] uppercase tracking-wide">Legajos Activos</p>
        </div>

        <div class="bg-white rounded-xl p-5 border border-[#E5E7EB] shadow-sm hover:shadow-md transition-all duration-300">
            <div class="flex items-center justify-between mb-3">
                <i class="fas fa-calendar-check text-xl text-[#F59E0B]"></i>
            </div>
            <p class="text-3xl font-bold mb-1 text-[#252F40]" x-text="metricas.seguimientos"></p>
            <p class="text-xs text-[#8C8C8C] uppercase tracking-wide">Seguimientos Hoy</p>
        </div>

        <div class="bg-white rounded-xl p-5 border border-[#E5E7EB] shadow-sm hover:shadow-md transition-all duration-300">
            <div class="flex items-center justify-between mb-3">
                <i class="fas fa-exclamation-triangle text-xl text-[#EF4444]"></i>
            </div>
            <p class="text-3xl font-bold mb-1 text-[#252F40]" x-text="metricas.alertas"></p>
            <p class="text-xs text-[#8C8C8C] uppercase tracking-wide">Alertas Activas</p>
        </div>
    </div>

    <!-- Dashboard Principal -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
        <!-- Gráfico de Tendencias -->
        <div class="lg:col-span-2 bg-white rounded-xl shadow-lg p-6">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-semibold text-gray-900">Tendencias Mensuales</h3>
                <div class="flex space-x-2">
                    <button @click="cambiarPeriodo('7d')" :class="periodo === '7d' ? 'bg-magenta text-white' : 'bg-gray-100 text-gray-600'" class="px-3 py-1 rounded-lg text-sm">7D</button>
                    <button @click="cambiarPeriodo('30d')" :class="periodo === '30d' ? 'bg-magenta text-white' : 'bg-gray-100 text-gray-600'" class="px-3 py-1 rounded-lg text-sm">30D</button>
                    <button @click="cambiarPeriodo('90d')" :class="periodo === '90d' ? 'bg-magenta text-white' : 'bg-gray-100 text-gray-600'" class="px-3 py-1 rounded-lg text-sm">90D</button>
                </div>
            </div>
            <div class="h-80">
                <canvas id="chartTendencias" class="w-full h-full"></canvas>
            </div>
        </div>

        <!-- Estados de Legajos -->
        <div class="bg-white rounded-xl shadow-lg p-6">
            <h3 class="text-xl font-semibold text-gray-900 mb-6">Estados de Legajos</h3>
            <div class="h-64">
                <canvas id="chartEstados" class="w-full h-full"></canvas>
            </div>
            <div class="mt-4 space-y-2">
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <div class="w-3 h-3 bg-nodo-cyan rounded-full mr-2"></div>
                        <span class="text-sm text-gray-600">Abiertos</span>
                    </div>
                    <span class="text-sm font-medium" x-text="estadosLegajos.abiertos"></span>
                </div>
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <div class="w-3 h-3 bg-nodo-purple rounded-full mr-2"></div>
                        <span class="text-sm text-gray-600">En Seguimiento</span>
                    </div>
                    <span class="text-sm font-medium" x-text="estadosLegajos.seguimiento"></span>
                </div>
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <div class="w-3 h-3 bg-magenta rounded-full mr-2"></div>
                        <span class="text-sm text-gray-600">Derivados</span>
                    </div>
                    <span class="text-sm font-medium" x-text="estadosLegajos.derivados"></span>
                </div>
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <div class="w-3 h-3 bg-gray-500 rounded-full mr-2"></div>
                        <span class="text-sm text-gray-600">Cerrados</span>
                    </div>
                    <span class="text-sm font-medium" x-text="estadosLegajos.cerrados"></span>
                </div>
            </div>
        </div>
    </div>

    <!-- Mapa de Calor y Actividad -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
        <!-- Mapa de Distribución -->
        <div class="bg-white rounded-xl shadow-lg p-6">
            <h3 class="text-xl font-semibold text-gray-900 mb-6">Distribución Geográfica</h3>
            <div id="mapa" class="h-80 rounded-lg"></div>
        </div>

        <!-- Timeline de Actividad -->
        <div class="bg-white rounded-xl shadow-lg p-6">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-semibold text-gray-900">Actividad en Tiempo Real</h3>
                <div class="flex items-center space-x-2">
                    <div class="w-2 h-2 bg-nodo-cyan rounded-full animate-pulse"></div>
                    <span class="text-sm text-gray-500">En vivo</span>
                </div>
            </div>
            <div class="space-y-4 max-h-80 overflow-y-auto">
                <template x-for="actividad in actividadReciente">
                    <div class="flex items-start space-x-3 p-3 rounded-lg hover:bg-gray-50 transition-colors">
                        <div class="flex-shrink-0">
                            <div :class="getIconoActividad(actividad.tipo)" class="w-8 h-8 rounded-full flex items-center justify-center">
                                <i :class="actividad.icono" class="text-sm"></i>
                            </div>
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="text-sm font-medium text-gray-900" x-text="actividad.descripcion"></p>
                            <p class="text-xs text-gray-500" x-text="actividad.usuario + ' • ' + actividad.tiempo"></p>
                        </div>
                    </div>
                </template>
            </div>
        </div>
    </div>

    <!-- Acciones Rápidas -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <div class="bg-white rounded-xl p-5 border border-[#E5E7EB] shadow-sm hover:shadow-md transition-all duration-300 cursor-pointer">
            <div class="flex items-center justify-between mb-3">
                <i class="fas fa-users text-xl text-[#3B82F6]"></i>
            </div>
            <h4 class="text-base font-semibold mb-1 text-[#252F40]">Gestionar Ciudadanos</h4>
            <p class="text-xs text-[#8C8C8C]">Ver, buscar y administrar</p>
        </div>

        <div class="bg-white rounded-xl p-5 border border-[#E5E7EB] shadow-sm hover:shadow-md transition-all duration-300 cursor-pointer">
            <div class="flex items-center justify-between mb-3">
                <i class="fas fa-plus-circle text-xl text-[#10B981]"></i>
            </div>
            <h4 class="text-base font-semibold mb-1 text-[#252F40]">Nuevo Registro</h4>
            <p class="text-xs text-[#8C8C8C]">Crear legajo rápido</p>
        </div>

        <div class="bg-white rounded-xl p-5 border border-[#E5E7EB] shadow-sm hover:shadow-md transition-all duration-300 cursor-pointer">
            <div class="flex items-center justify-between mb-3">
                <i class="fas fa-chart-bar text-xl text-[#8B5CF6]"></i>
            </div>
            <h4 class="text-base font-semibold mb-1 text-[#252F40]">Reportes</h4>
            <p class="text-xs text-[#8C8C8C]">Análisis y estadísticas</p>
        </div>

        <div class="bg-white rounded-xl p-5 border border-[#E5E7EB] shadow-sm hover:shadow-md transition-all duration-300 cursor-pointer">
            <div class="flex items-center justify-between mb-3">
                <i class="fas fa-cog text-xl text-[#8C8C8C]"></i>
            </div>
            <h4 class="text-base font-semibold mb-1 text-[#252F40]">Configuración</h4>
            <p class="text-xs text-[#8C8C8C]">Ajustes del sistema</p>
        </div>
    </div>

    <!-- Estado del Sistema Avanzado -->
    <div class="bg-white rounded-xl shadow-lg p-6">
        <h3 class="text-xl font-semibold text-gray-900 mb-6">Estado del Sistema</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
            <div class="text-center">
                <div class="inline-flex items-center justify-center w-16 h-16 bg-cyan-100 rounded-full mb-4">
                    <i class="fas fa-server text-nodo-cyan text-2xl"></i>
                </div>
                <h4 class="font-semibold text-gray-900 mb-2">Servidor</h4>
                <div class="bg-gray-200 rounded-full h-2 mb-2">
                    <div class="bg-[#08B8CC] h-2 rounded-full" style="width: 95%"></div>
                </div>
                <p class="text-sm text-gray-500">95% Rendimiento</p>
            </div>

            <div class="text-center">
                <div class="inline-flex items-center justify-center w-16 h-16 bg-purple-100 rounded-full mb-4">
                    <i class="fas fa-database text-nodo-purple text-2xl"></i>
                </div>
                <h4 class="font-semibold text-gray-900 mb-2">Base de Datos</h4>
                <div class="bg-gray-200 rounded-full h-2 mb-2">
                    <div class="bg-[#7928CA] h-2 rounded-full" style="width: 88%"></div>
                </div>
                <p class="text-sm text-gray-500">88% Uso</p>
            </div>

            <div class="text-center">
                <div class="inline-flex items-center justify-center w-16 h-16 bg-pink-100 rounded-full mb-4">
                    <i class="fas fa-shield-alt text-magenta text-2xl"></i>
                </div>
                <h4 class="font-semibold text-gray-900 mb-2">Seguridad</h4>
                <div class="bg-gray-200 rounded-full h-2 mb-2">
                    <div class="bg-[#FF0080] h-2 rounded-full" style="width: 100%"></div>
                </div>
                <p class="text-sm text-gray-500">Protección Activa</p>
            </div>

            <div class="text-center">
                <div class="inline-flex items-center justify-center w-16 h-16 bg-yellow-100 rounded-full mb-4">
                    <i class="fas fa-users text-yellow-600 text-2xl"></i>
                </div>
                <h4 class="font-semibold text-gray-900 mb-2">Usuarios</h4>
                <div class="bg-gray-200 rounded-full h-2 mb-2">
                    <div class="bg-[#F59E0B] h-2 rounded-full" style="width: 67%"></div>
                </div>
                <p class="text-sm text-gray-500" x-text="usuariosConectados + ' conectados'"></p>
            </div>
        </div>
    </div>
</div>

<script>
function dashboard() {
    return {
        darkMode: false,
        busqueda: '',
        resultadosBusqueda: [],
        periodo: '30d',
        notificaciones: 5,
        usuariosConectados: 12,
        saludo: '',
        fechaHora: '',
        metricas: {
            ciudadanos: {{ total_ciudadanos|default:"0" }},
            legajos: {{ legajos_activos|default:"0" }},
            seguimientos: {{ seguimientos_hoy|default:"0" }},
            alertas: {{ alertas_activas|default:"0" }}
        },
        estadosLegajos: {
            abiertos: 45,
            seguimiento: 78,
            derivados: 23,
            cerrados: 10
        },
        alertasCriticas: [
            { ciudadano: 'Juan Pérez', tipo: 'Riesgo Alto', fecha: 'Hace 2 horas' },
            { ciudadano: 'María García', tipo: 'Sin Contacto', fecha: 'Hace 4 horas' },
            { ciudadano: 'Carlos López', tipo: 'Seguimiento Vencido', fecha: 'Ayer' }
        ],
        actividadReciente: [
            { descripcion: 'Nuevo legajo creado', usuario: 'Dr. Martínez', tiempo: 'Hace 5 min', tipo: 'create', icono: 'fas fa-plus' },
            { descripcion: 'Seguimiento completado', usuario: 'Lic. Rodríguez', tiempo: 'Hace 12 min', tipo: 'update', icono: 'fas fa-check' },
            { descripcion: 'Alerta generada', usuario: 'Sistema', tiempo: 'Hace 18 min', tipo: 'alert', icono: 'fas fa-exclamation-triangle' },
            { descripción: 'Usuario conectado', usuario: 'Dra. Fernández', tiempo: 'Hace 25 min', tipo: 'login', icono: 'fas fa-sign-in-alt' }
        ],

        init() {
            this.actualizarSaludo();
            this.actualizarFechaHora();
            this.cargarDatosIniciales();
            this.inicializarGraficos();
            this.inicializarMapa();
            setInterval(() => this.actualizarFechaHora(), 1000);
            setInterval(() => this.actualizarDatos(), 30000);
        },
        
        cargarDatosIniciales() {
            fetch('/dashboard/api/alertas-criticas/')
                .then(response => response.json())
                .then(data => {
                    this.alertasCriticas = data.results;
                    this.notificaciones = data.results.length;
                })
                .catch(error => console.error('Error cargando alertas:', error));
            
            fetch('/dashboard/api/actividad-reciente/')
                .then(response => response.json())
                .then(data => {
                    this.actividadReciente = data.results;
                })
                .catch(error => console.error('Error cargando actividad:', error));
        },

        actualizarSaludo() {
            const hora = new Date().getHours();
            const nombre = '{{ user.get_full_name|default:user.username }}';
            if (hora < 12) this.saludo = `Buenos días, ${nombre}`;
            else if (hora < 18) this.saludo = `Buenas tardes, ${nombre}`;
            else this.saludo = `Buenas noches, ${nombre}`;
        },

        actualizarFechaHora() {
            const ahora = new Date();
            this.fechaHora = ahora.toLocaleDateString('es-AR', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        },

        toggleTheme() {
            this.darkMode = !this.darkMode;
            document.documentElement.classList.toggle('dark', this.darkMode);
        },

        buscarCiudadano() {
            if (this.busqueda.length < 3) {
                this.resultadosBusqueda = [];
                return;
            }
            
            fetch(`/dashboard/api/buscar-ciudadanos/?q=${encodeURIComponent(this.busqueda)}`)
                .then(response => response.json())
                .then(data => {
                    this.resultadosBusqueda = data.results || [];
                })
                .catch(error => {
                    console.error('Error en búsqueda:', error);
                    this.resultadosBusqueda = [];
                });
        },

        cambiarPeriodo(nuevoPeriodo) {
            this.periodo = nuevoPeriodo;
            this.actualizarGraficoTendencias();
        },

        getIconoActividad(tipo) {
            const colores = {
                create: 'bg-cyan-100 text-nodo-cyan',
                update: 'bg-purple-100 text-nodo-purple',
                alert: 'bg-red-100 text-red-600',
                login: 'bg-pink-100 text-magenta'
            };
            return colores[tipo] || 'bg-gray-100 text-gray-600';
        },

        inicializarGraficos() {
            // Gráfico de tendencias
            const ctxTendencias = document.getElementById('chartTendencias').getContext('2d');
            new Chart(ctxTendencias, {
                type: 'line',
                data: {
                    labels: ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun'],
                    datasets: [{
                        label: 'Nuevos Legajos',
                        data: [12, 19, 15, 25, 22, 30],
                        borderColor: 'rgb(255, 0, 128)',
                        backgroundColor: 'rgba(255, 0, 128, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true } }
                }
            });

            // Gráfico de estados
            const ctxEstados = document.getElementById('chartEstados').getContext('2d');
            new Chart(ctxEstados, {
                type: 'doughnut',
                data: {
                    labels: ['Abiertos', 'En Seguimiento', 'Derivados', 'Cerrados'],
                    datasets: [{
                        data: [45, 78, 23, 10],
                        backgroundColor: ['#08B8CC', '#7928CA', '#FF0080', '#6b7280']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } }
                }
            });

            // Mini gráficos en métricas
            ['chartCiudadanos', 'chartLegajos', 'chartSeguimientos', 'chartAlertas'].forEach(id => {
                const ctx = document.getElementById(id).getContext('2d');
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: ['', '', '', '', '', ''],
                        datasets: [{
                            data: [10, 15, 12, 18, 16, 20],
                            borderColor: 'rgba(255, 255, 255, 0.8)',
                            backgroundColor: 'rgba(255, 255, 255, 0.1)',
                            borderWidth: 2,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            x: { display: false },
                            y: { display: false }
                        },
                        elements: { point: { radius: 0 } }
                    }
                });
            });
        },

        inicializarMapa() {
            const mapa = L.map('mapa').setView([-34.6037, -58.3816], 10);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(mapa);
            
            // Puntos de ejemplo
            const puntos = [
                [-34.6037, -58.3816, 'Centro: 25 casos'],
                [-34.6158, -58.3731, 'Norte: 18 casos'],
                [-34.5875, -58.3974, 'Sur: 32 casos']
            ];
            
            puntos.forEach(([lat, lng, texto]) => {
                L.marker([lat, lng]).addTo(mapa).bindPopup(texto);
            });
        },

        actualizarDatos() {
            fetch('/dashboard/api/metricas/')
                .then(response => response.json())
                .then(data => {
                    this.metricas = data.metricas;
                    this.estadosLegajos = data.estados_legajos;
                    this.usuariosConectados = data.usuarios_conectados;
                })
                .catch(error => console.error('Error actualizando métricas:', error));
            
            this.cargarDatosIniciales();
        }
    }
}
</script>
{% endblock %}